# Agent Prompts for OpenClaw Tools (Windows-Side)

These prompts build custom tools that OpenClaw uses to manage project work.

CRITICAL ARCHITECTURE NOTE: All project files live on RO-WIN at C:\_projects_\flcprojects\.
The NAS container cannot access Windows filesystem directly — there is no SMB mount.
Tools in Prompts 1-4 run on RO-WIN and are triggered by OpenClaw via SSH.
Only Prompt 5 (task tracker) runs on the NAS.

Tools location on RO-WIN: C:\_projects_\project_factory\tools\  (create this directory)
Tools location on NAS: /volume1/docker/nasopenclaw/tools/  (Prompt 5 only)

Standard library Python only — no pip packages.

Read README-NAS.md before starting any prompt to understand the NAS/Windows split.

---

## PROMPT 1 — Build: Project Context Loader (runs on RO-WIN)

**Files to read first**:
- `C:\_projects_\project_factory\CLAUDE.md`
- `C:\_projects_\project_tailor\MULTI_AGENT_ARCHITECTURE.md`
- `C:\_projects_\project_factory\AGENT_PROMPTS.md` (Prompt 7 — SYSTEM_CAPABILITIES.md)

**Purpose**: Before sending any task to the agent, OpenClaw SSH-es into RO-WIN and
runs this script to get accurate project context. The output is prepended to every
agent task so the agent knows the project type, template, locked files, URLs, and
database info without guessing.

**Build**: Create `C:\_projects_\project_factory\tools\load_project_context.py`

```bash
# OpenClaw calls this via SSH:
ssh user@RO-WIN "python C:\\_projects_\\project_factory\\tools\\load_project_context.py C:\\_projects_\\flcprojects\\medical-directory"
```

The script accepts one argument: the absolute Windows path to the project directory.

Files to read from the project (in priority order):
1. `SYSTEM_CAPABILITIES.md` — pre-generated by Factory, has everything pre-computed.
   If this file exists, use it as the primary source. Extract and reformat its content.
2. `.factory.json` — fallback for type, db, locked, db_info if SYSTEM_CAPABILITIES.md absent
3. `.tailor.json` — template name and version (if exists)

Output format (printed to stdout):

```
=== PROJECT CONTEXT ===
Project: medical-directory
Type: astro-website
Template: directory (v1.0.0, applied 2026-02-22)
Database: sqld (namespaces: medical_directory_dev / medical_directory_stg / medical_directory_prod)
Locked: YES — push to development only, never staging or master

Environments:
  Development: https://d-medical-directory.secureit.solutions
  Staging:     https://s-medical-directory.secureit.solutions
  Production:  https://medical-directory.secureit.solutions

Folder conventions (astro-website with directory template):
  src/components/  — UI components (.astro, .vue)
  src/services/    — Pure TypeScript business logic
  src/content/     — Schemas, data, config
  src/pages/       — LOCKED: pre-written by template, do not modify
  src/lib/         — LOCKED: shared utilities, request changes explicitly
  astro.config.mjs — LOCKED: set by template, do not modify

Git rules:
  - Always work on development branch
  - Never push to staging or master
  - Commit message format: feat: / fix: / chore:
=== END PROJECT CONTEXT ===
```

Folder conventions section is only shown for astro-website type — other types have
no enforced folder structure so omit that section.

If `SYSTEM_CAPABILITIES.md` is absent, construct the output from `.factory.json` and
`.tailor.json` only — URLs will not be available, output a warning:
`  URLs: not available (SYSTEM_CAPABILITIES.md missing — re-run Factory setup)`

Exit code 0 on success, 1 if project directory does not exist or has no `.factory.json`.

**Success criteria**: Running the script against a real project outputs a correctly
populated context block with no placeholder values and accurate URLs when
SYSTEM_CAPABILITIES.md is present.

---

## PROMPT 2 — Build: Shared File Validator (runs on RO-WIN)

**Files to read first**:
- `C:\_projects_\project_tailor\MULTI_AGENT_ARCHITECTURE.md` (Shared File Validation section)
- `C:\_projects_\project_tailor\lib\protect.py` (to understand what is already protected)

**Purpose**: Before OpenClaw commits agent work, it SSH-es into RO-WIN and runs this
script to diff protected shared files against their pre-task state. If any changed,
log the diff and require confirmation before committing.

**Build**: Create `C:\_projects_\project_factory\tools\validate_shared_files.py`

Two modes:

**Mode 1: snapshot** — call at the START of a task, before agent runs
```bash
ssh user@RO-WIN "python C:\\_projects_\\project_factory\\tools\\validate_shared_files.py snapshot C:\\_projects_\\flcprojects\\medical-directory"
# Writes .openclaw_snapshot.json inside the project root
# Exit 0 on success
```

**Mode 2: check** — call BEFORE committing, after agent has made changes
```bash
ssh user@RO-WIN "python C:\\_projects_\\project_factory\\tools\\validate_shared_files.py check C:\\_projects_\\flcprojects\\medical-directory"
# Reads .openclaw_snapshot.json, compares current state
# Exit 0 if nothing changed
# Exit 1 if anything changed — prints which files and a brief diff
```

Protected files to monitor:
```python
PROTECTED = [
    'astro.config.mjs',
    'tsconfig.json',
    'src/lib/',     # entire directory — hash every file inside recursively
    'src/pages/',   # entire directory — hash every file inside recursively
]
```

For directories: walk all files, hash each with SHA256. A file appearing that was not
in the snapshot counts as a change.

`.openclaw_snapshot.json` must be appended to `.gitignore` by the snapshot command
if not already present. It must never be committed.

On check failure, output format:
```
Protected files changed:
  MODIFIED: astro.config.mjs
  ADDED:    src/lib/newutil.ts
Review these changes before committing.
```

**Success criteria**:
1. snapshot writes `.openclaw_snapshot.json` with correct SHA256 hashes
2. check exits 0 with "All protected files unchanged" when nothing changed
3. check exits 1 and lists changed files when astro.config.mjs is modified
4. check exits 1 and reports ADDED when a new file appears in src/lib/

---

## PROMPT 3 — Build: Test Runner (runs on RO-WIN)

**Files to read first**:
- `C:\_projects_\project_tailor\MULTI_AGENT_ARCHITECTURE.md` (Testing Strategy section)

**Purpose**: OpenClaw SSH-es into RO-WIN and runs this script after the agent completes
a task. If tests fail, the output is sent back to the agent to fix before committing.
Node.js is available on RO-WIN — this runs natively, no SSH indirection needed
from the script itself.

**Build**: Create `C:\_projects_\project_factory\tools\run_tests.py`

```bash
# OpenClaw calls via SSH:
ssh user@RO-WIN "python C:\\_projects_\\project_factory\\tools\\run_tests.py C:\\_projects_\\flcprojects\\medical-directory [suite]"
# suite: unit | build | integration | all (default: all)
```

Test commands:
```python
SUITES = {
    "unit":        ["npm", "run", "test:unit"],
    "build":       ["npm", "run", "build"],
    "integration": ["npm", "run", "test:integration"],
    "all":         [
        ["npm", "run", "test:unit"],
        ["npm", "run", "build"],
        ["npm", "run", "test:integration"],
    ]
}
```

For `all`, run in sequence and stop on first failure.

The script reads `.factory.json` to determine project type. If the project type is
not a JS type (`astro-website`, `react-website`, `nextjs-app`, `astro-app`,
`html-website`), skip the build and integration suites and only run `unit` if a
`requirements.txt` and `pytest` setup exists — otherwise print "No test suite
configured for this project type" and exit 0.

Output:
```
[unit] Running npm run test:unit...
  PASS tests/services/filterService.test.ts (12ms)
  Result: 24/24 passing ✓

[build] Running npm run build...
  Result: success (18.3s) ✓

[integration] Running npm run test:integration...
  Result: 6/6 passing ✓

All suites passed.
```

On failure, capture and print the full stderr/stdout from the failed command,
then exit 1.

**Success criteria**:
1. `all` suite runs unit → build → integration in order, stops on first failure
2. Failure output includes the full error from npm (not truncated)
3. Exit code 0 on all pass, 1 on any failure
4. Non-JS project types exit 0 cleanly with an informational message

---

## PROMPT 4 — Build: Git Commit and Push Tool (runs on RO-WIN)

**Files to read first**:
- `C:\_projects_\project_factory\lib\github.py` (lock system)
- `C:\_projects_\project_tailor\MULTI_AGENT_ARCHITECTURE.md` (Git Workflow section)

**Purpose**: OpenClaw SSH-es into RO-WIN and runs this script to commit agent changes
and push to development. Enforces branch lock, runs shared file validator, produces
clean audit trail.

**Build**: Create `C:\_projects_\project_factory\tools\git_push.py`

```bash
# OpenClaw calls via SSH:
ssh user@RO-WIN "python C:\\_projects_\\project_factory\\tools\\git_push.py C:\\_projects_\\flcprojects\\medical-directory \"feat: add price range filter\" [--skip-validation] [--force-protected]"
```

Workflow in strict order:

1. Read `.factory.json` — confirm `locked: true` is set
2. Get current branch: `git rev-parse --abbrev-ref HEAD`
   - If not `development`: print error and exit 1
   - Never push to any other branch
3. Run `validate_shared_files.py check` (call as subprocess) unless `--skip-validation`
   - If exit code 1 (protected files changed):
     - If `--force-protected` passed: log warning and continue
     - Otherwise: print diff output and exit 1 with message "Revert protected file
       changes or use --force-protected to override"
4. `git add -A`
5. `git status --porcelain` — if empty, print "Nothing to commit" and exit 0
6. `git commit -m "{message}"`
7. `git push origin development`
8. Print the commit hash: `git rev-parse HEAD`

Never silently swallow errors. If any git command fails, print the full error and exit 1.

**Success criteria**:
1. Wrong branch → clear error, exit 1, nothing committed
2. Protected files changed without `--force-protected` → exit 1 with diff
3. Protected files changed with `--force-protected` → logs warning, commits anyway
4. Clean task → commits and pushes, prints commit hash
5. Nothing to commit → exits 0 cleanly

---

## PROMPT 5 — Build: Task State Tracker (runs on NAS)

**Files to read first**:
- `/volume1/docker/nasopenclaw/README-NAS.md`
- `C:\_projects_\project_tailor\MULTI_AGENT_ARCHITECTURE.md` (OpenClaw Integration section)

**Purpose**: Track agent task state on the NAS so tasks are retryable if OpenClaw
crashes or the session drops. This is the only tool that lives on the NAS — it only
manages JSON, no project file access needed.

**Build**: Create `/volume1/docker/nasopenclaw/tools/task_tracker.py`

State file: `/volume1/docker/nasopenclaw/tasks.json` (create on first run if absent)

Task states: `queued` → `running` → `testing` → `done` | `failed`

```bash
# Create
python task_tracker.py create --project medical-directory --description "add price filter" --model "anthropic/claude-sonnet-4-5"
# Prints: task_20260222_001

# Update
python task_tracker.py update task_20260222_001 --state running
python task_tracker.py update task_20260222_001 --state done --commit abc1234
python task_tracker.py update task_20260222_001 --state failed --error "Build failed at filterService.ts:24"

# List (default: last 10, newest first)
python task_tracker.py list
python task_tracker.py list --project medical-directory
python task_tracker.py list --state failed

# Show one task in full
python task_tracker.py show task_20260222_001
```

Task structure:
```json
{
  "id": "task_20260222_001",
  "project": "medical-directory",
  "description": "add price filter",
  "model": "anthropic/claude-sonnet-4-5",
  "state": "done",
  "created_at": "2026-02-22T10:00:00Z",
  "updated_at": "2026-02-22T10:22:00Z",
  "commit": "abc1234",
  "error": null
}
```

ID format: `task_YYYYMMDD_NNN` where NNN increments from 001 each day, resetting
at midnight. Use UTC for all timestamps.

Keep the last 100 tasks. When writing, if over 100, drop oldest first.

File locking: use a `.tasks.lock` file with `fcntl` (Linux) to prevent concurrent
writes. Hold lock for write operations only, release immediately after.

**Success criteria**:
1. `create` writes to `tasks.json` and prints the new ID
2. `update` modifies only the specified fields, updates `updated_at`
3. `list` without filters shows last 10 tasks newest-first
4. `list --state failed` shows only failed tasks
5. Tasks survive a script restart (file-backed, not in-memory)
6. 101st task causes the oldest to be dropped, keeping exactly 100
